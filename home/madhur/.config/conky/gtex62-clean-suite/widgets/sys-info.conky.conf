--[[
  ~/.config/conky/gtex62-clean-suite/widgets/sys-info.conky.conf
  System info + CPU/RAM/GPU slash bars widget

  • Uses theme.lua for fonts/colors (default_color, color1, pipe columns).
  • Uses lua/widgets.lua for helpers:
      - sep_auto, indent, slash_fixed_auto, pct, top* helpers, etc.
  • Shows:
      - Date, uptime, Mint version, hostname, kernel
      - Disk usage for / and /home
      - CPU/RAM usage with Rainmeter-style slash bars + top processes
      - GPU load/VRAM (if NVIDIA is present) + basic hardware IDs.
]]
local theme = dofile(os.getenv("HOME") .. "/.config/conky/gtex62-clean-suite/theme.lua")

conky.config = {
  alignment              = 'top_left',
  background             = false,
  double_buffer          = true,
  update_interval        = 1,

  use_xft                = true,
  font                   = theme.font or 'DejaVu Sans Mono:size=10',

  own_window             = true,
  own_window_type        = 'desktop',
  own_window_hints       = 'undecorated,sticky,skip_taskbar,skip_pager,below',
  own_window_argb_visual = true,
  own_window_argb_value  = 0,
  own_window_transparent = true,
  own_window_class       = 'Conky',

  -- lock width so slash bars don’t grow/shrink
  minimum_width          = 360,
  maximum_width          = 360,

  -- position
  gap_x                  = 2780,
  gap_y                  = 30,

  draw_shades            = false,
  draw_borders           = false,

  -- prepend '#' because theme.default_color / color1 are bare hex values
  default_color          = '#' .. (theme.default_color or 'FFFFFF'),
  color1                 = '#' .. (theme.color1 or 'A0A0A0'),

  -- pipe columns from theme.lua
  template1              = string.format("${goto %d}", theme.pipe_col or 185),  -- first pipe
  template2              = string.format("${goto %d}", theme.pipe2_col or 255), -- second pipe

  -- load our Lua helpers
  lua_load               = os.getenv("HOME") .. "/.config/conky/gtex62-clean-suite/lua/widgets.lua",
}

conky.text = [[
${color1}${time %a, %b %d %Y}  ${time %H:%M:%S}${color}
${color1}Uptime${color} ${uptime}

${color1}Mint${color} ${execpi 86400 ~/.config/conky/gtex62-clean-suite/scripts/mint_version.sh}
${color1}${nodename}${color}  ${user_names}   ${color1}Kernel${color} ${kernel}
# ${voffset 1}${color1}Updates${color} ${execi 900 sh -c 'apt list --upgradeable 2>/dev/null | awk "NR>1{c++} END{print c+0}"'} available

${voffset 1}${color1}Disk${color}      Size    | Used    | Avail   | Use%
${color1}/sda2${color}     ${fs_size /} | ${fs_used /} | ${fs_free /} | ${fs_used_perc /}%
${color1}/sda3${color}     ${fs_size /home}  | ${fs_used /home} | ${fs_free /home}  | ${fs_used_perc /home}%
# ${if_match ${execi 300 awk '/^SwapTotal:/ {print $2}' /proc/meminfo} > 0}${color1}Swap${color} $swap / $swapmax  ${swapbar 8}
${lua_parse sep_auto}

${color1}CPU${color} ${lua_parse slash_fixed_auto ${cpu}} ${lua_parse pct ${cpu} 3}
${lua_parse indent}${lua_parse topname 1 26}${template1}| ${lua_parse topcpu 1 2}
${lua_parse indent}${lua_parse topname 2 26}${template1}| ${lua_parse topcpu 2 2}
${lua_parse indent}${lua_parse topname 3 26}${template1}| ${lua_parse topcpu 3 2}
${lua_parse indent}${lua_parse topname 4 26}${template1}| ${lua_parse topcpu 4 2}
${lua_parse indent}${lua_parse topname 5 26}${template1}| ${lua_parse topcpu 5 2}

${lua_parse sep_auto}

${color1}RAM${color} ${lua_parse slash_fixed_auto ${memperc}} ${lua_parse pct ${memperc} 3}
${lua_parse indent}${lua_parse topmemname 1 26}${template1}| ${lua_parse topmemres 1}
${lua_parse indent}${lua_parse topmemname 2 26}${template1}| ${lua_parse topmemres 2}
${lua_parse indent}${lua_parse topmemname 3 26}${template1}| ${lua_parse topmemres 3}
${lua_parse indent}${lua_parse topmemname 4 26}${template1}| ${lua_parse topmemres 4}
${lua_parse indent}${lua_parse topmemname 5 26}${template1}| ${lua_parse topmemres 5}

${lua_parse sep_auto}
${if_existing /proc/driver/nvidia/version}
# NVIDIA GPU branch (uses nvidia-smi for metrics)
${color1}GPU${color} ${lua_parse slash_fixed_auto ${execpi 10 nvidia-smi --query-gpu=utilization.gpu --format=csv,noheader,nounits 2>/dev/null | head -n1}} ${lua_parse pct ${execpi 10 nvidia-smi --query-gpu=utilization.gpu --format=csv,noheader,nounits 2>/dev/null | head -n1} 3}
${lua_parse indent}Driver${template1}| ${execpi 3600 nvidia-smi --query-gpu=driver_version --format=csv,noheader 2>/dev/null | head -n1}
${lua_parse indent}Temp${template1}| ${execpi 10 nvidia-smi --query-gpu=temperature.gpu --format=csv,noheader,nounits 2>/dev/null | head -n1}°C
${lua_parse indent}Power${template1}| ${execpi 10 nvidia-smi --query-gpu=power.draw --format=csv,noheader,nounits 2>/dev/null | head -n1} W
${color1}VRM${color} ${lua_parse slash_fixed_auto ${execpi 10 nvidia-smi --query-gpu=memory.used,memory.total --format=csv,noheader,nounits 2>/dev/null | head -n1 | awk -F',' '{u=$1+0;t=$2+0; if(t>0) printf "%d", int((u*100)/t+0.5); else print 0}'}} ${lua_parse pct ${execpi 10 nvidia-smi --query-gpu=memory.used,memory.total --format=csv,noheader,nounits 2>/dev/null | head -n1 | awk -F',' '{u=$1+0;t=$2+0; if(t>0) printf "%d", int((u*100)/t+0.5); else print 0}'} 3}
${else}
# Fallback branch when no NVIDIA driver is present
${color1}GPU${color} ${lua_parse slash_fixed_auto 0} ${lua_parse pct 0 3}
${lua_parse indent}- ${template1}| 0.0 kB ${template2}| 0.0%
${lua_parse indent}- ${template1}| 0.0 kB ${template2}| 0.0%
${lua_parse indent}- ${template1}| 0.0 kB ${template2}| 0.0%
${lua_parse indent}- ${template1}| 0.0 kB ${template2}| 0.0%
${lua_parse indent}- ${template1}| 0.0 kB ${template2}| 0.0%
${endif}
${lua_parse sep_auto}

${color1}CPU ${color} ${execpi 300 awk -F': ' '/model name/ {print $2; exit}' /proc/cpuinfo}
${color1}GPU ${color} ${execpi 30 nvidia-smi --query-gpu=name --format=csv,noheader 2>/dev/null | head -n1}
${color1}MBD ${color} ${execpi 300 cat /sys/devices/virtual/dmi/id/board_name}
${color1}BIOS${color} ${execpi 300 cat /sys/devices/virtual/dmi/id/bios_version}

${lua_parse sep_auto}
]]
